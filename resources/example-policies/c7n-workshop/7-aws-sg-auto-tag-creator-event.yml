policies:
  - name: aws-security-group-auto-tag-creator
    resource: security-group
    mode:
      type: cloudtrail
      role: arn:aws:iam::{account_id}:role/system/c7n-workshop-lambda-role
      tags:
        c7n-workshop: " "
      events:
        - source: ec2.amazonaws.com
          event: CreateSecurityGroup
          ids: "responseElements.groupId"
    actions:
      - type: auto-tag-user
        tag: CreatorName
      - type: tag
        tags:
          c7n-workshop: "it worked!"

  - name: aws-security-group-auto-tag-modifier
    resource: security-group
    mode:
      type: cloudtrail
      role: arn:aws:iam::{account_id}:role/system/c7n-workshop-lambda-role
      tags:
        c7n-workshop: " "
      events:
        - source: ec2.amazonaws.com
          event: AuthorizeSecurityGroupIngress
          ids: "requestParameters.groupId"
        - source: ec2.amazonaws.com
          event: AuthorizeSecurityGroupEgress
          ids: "requestParameters.groupId"
        - source: ec2.amazonaws.com
          event: RevokeSecurityGroupEgress
          ids: "requestParameters.groupId"
        - source: ec2.amazonaws.com
          event: RevokeSecurityGroupIngress
          ids: "requestParameters.groupId"
    actions:
      - type: auto-tag-user
        tag: LastModifiedByUser
      - type: tag
        tags:
          c7n-workshop: "it worked!"

  - name: aws-ec2-start-instance-auto-tag-user
    resource: aws.ec2
    mode:
      type: cloudtrail
      role: arn:aws:iam::{account_id}:role/system/c7n-workshop-lambda-role
      tags:
        c7n-workshop: " "
      events:
        - source: ec2.amazonaws.com
          event: StartInstances
          ids: "responseElements.instancesSet.items[].instanceId"
    description: |
      Tags the last user to start the EC2 instance
    actions:
      - type: auto-tag-user
        tag: ServerStartedBy
      - type: tag
        tags:
          c7n-workshop: "it worked!"

  - name: aws-ec2-stopped-instance-auto-tag-user
    resource: ec2
    mode:
      type: cloudtrail
      role: arn:aws:iam::{account_id}:role/system/c7n-workshop-lambda-role
      tags:
        c7n-workshop: " "
      events:
        - source: ec2.amazonaws.com
          event: StopInstances
          ids: "responseElements.instancesSet.items[].instanceId"
    description: |
      Tags the user which last stopped the EC2 instance.
    actions:
      - type: auto-tag-user
        tag: ServerStoppedBy
      - type: tag
        tags:
          c7n-workshop: "it worked!"
